---
layout: post
title: 新版架构说明
---

<h2>新版架构说明</h2>
<div>
	用了比较长的时间尝试修改架构，目前已基本完成视图控制部分，分享一下

	<p>1.结构调整，从过去的三层结构调整为一层，页面都只有一层data-page环绕的div。</p>
	<p>2.历史记录调整,已完成hash的替换，暂时或许日后会使用第三方库在支持state的情况下使用该库。</p>
	<p>3.iframe的替换，因为调整结构顺便就把iframe全部换成div了，而div中使用了类mvc作用域保证事件不外泄</p>
	<p>4.动画库强化。替换成css3动画了，非常便捷</p>
	<p>5.增加页面控制类，主要因为替换了iframe所以需要作用域保护</p>
	<p>6.增加回调插件，页面控制可以随时调用想用的功能了</p>
	
</div>
<h3>运行流程</h3>
<div>
	先说一下现在的工作模式：
	<p>1.首先不管如何你需要打开页面。</p>
	<p>2.页面加载完成后创建data-page环绕页面所有内容。</p>
	<p>3.请求了新的页面跳转把超链变成hash处理。</p>
	<p>4.进入hashchange如果该页面不存在则请求一个新页面。</p>
	<p>5.非常优雅的解析出内容标签，然后塞进一个新的data-page里，并在页面生成。</p>
	<p>6.当前page与目标page进行替换动画。</p>
	<p>7.激活目标page初始化事件。</p>
	
</div>
<p>
	实际上第7步速度要比第6步略快，因为动画使用了setTimeout变成了异步处理，当然因为初始化事件几乎不影响动画执行，所以基本可以不在意执行顺序。<br/>
	可以看到这里只要打开一个页面就会生成一个根节点，而所有请求页面都被封装成data-page，这样做的好处是所有页面都是入口，并不像之前的架构必须通过单独的入口页面进入才能正常初始化。<br/>并且替换了iframe执行效率高的不可思议，内存占用从150+M降低为8M。提升了20余倍。（所以iframe这种弱智玩意赶紧丢了吧，除了统计用几乎没人用了）<br/>不得不说的是为了替换iframe想尽了办法突然发现前端mvc这种东西，稍作研究恍然大悟，原来还可以这么搞。事件直接代理到父层data-page上，就不会影响到其他data-page。而且是一种非常优雅的做法，只是我不喜欢backbone的分层所以就自己处理了一下只使用了事件托管的模式。<br />于是类mvc无缝切换pajx架构就诞生了，只是现在pushState没了应该叫hash+ajax。
</p>
<h3>架构分层</h3>
<div>
	特别说一下现在的分层情况
	<p>transition：架构逻辑层，负责处理页面生成逻辑，监听页面切换并执行动画</p>
	<p>zly：页面逻辑层，主要处理单页面逻辑，封闭单页面作用域</p>
	<p>command：功能层，插件和相应事件的提供者</p>
</div>
<p>其他内容几乎和上一版架构相同，jquery、event等<br/>不得不说的是我仍然决定使用jquery，因为zepto的功能实在是弱爆了，想要更完善更健康的api还是jquery+zepto.touch这种组合会比较好，顺便把类似css3的各种前缀+事件名提取成一共总的event用起来也是非常舒畅的<br/>如果有可能我还会再处理一下缓存部分，目前在生成到页面的同时也缓存了一份到local中只是没有使用。可以一次只获取一个页面或者几个有关联的页面再提高执行速度，降低内存占用，预计可以到2m之内<br/>就目前来说在我的单核me525+下执行也是完全没有卡顿现象,终于有那么点流畅的感觉了，只需要把点击效果做的再优雅点，再多一点点的loading效果就可以挑战一些原生app的交互体验了<br>如果有感兴趣的朋友可以留言联系一下</p>

<p>{{ page.date | date_to_string }}</p>